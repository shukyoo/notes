
### 结论    
1. mysql的查询和数据量的大小关系并不大
2. mysql只要是命中索引，不管数据量有多大，都会非常快

### 什么时候需要分库分表？
1. 单表，不涉及索引的操作太多，无法直接命中索引的
2. 模糊查找范围过大，无法直接命中索引的，例如日志表查时间区间
3. 单表数据量过大，操作繁忙的
4. 数据量过大，有大部分数据很少访问的（冷热数据）


### 数据分表有着以下好处
1. 分散表压力，使其响应速度提高
2. 数据降维，提升查询速度
3. 分冷热数据，更好管理，备份
4. 支持分布式部署数据库，将压力分担到其他服务器中

### 缺点如下
1. 分表之后较难管理多表
2. join表时可能需要join多个
3. 查询模糊数据时需要全部的表一起查

*所以，数据量不大时候，不建议分表。*


## 大表的问题
* 未命中索引情况下查询很慢
* DDL操作很慢，风险：引起主从延迟，锁表风险
* 数据备份和恢复很慢


# 不同的分库分表方案对比
## 1、MySql分库分表方案
MySql自身拥有强大的数据查询、分析功能，基于MyQql创建订单系统，可以应对订单数据多维查询、统计场景。伴随着订单数据量的增加，用户会采取分库、分表方案应对，通过这种伪分布式方案，解决数据膨胀带来的问题。但数据一旦达到瓶颈，便需要重新创建更大规模的分库+数据的全量迁移，麻烦就会不断出现。数据迭代、膨胀带来的困扰，是MySql方案难于逾越的。仅仅依靠MySql的传统订单方案短板凸显。
1. 数据纵向（数据规模）膨胀：采用分库分表方案，MySql在部署时需要预估分库规模，数据量一旦达到上限后，重新部署并做数据全量迁移；
2. 数据横向（字段维度）膨胀：schema需预定义，迭代新增新字段变更复杂。而维度到达一定量后影响数据库性能；

## 2、MySql+HBase方案
引入双数据的方案应运而生，通过实时数据、历史数据分存的方案，可以一定程度解决数据量膨胀问题。该方案将数据归类成两部分存储：实时数据、历史数据。同时通过数据同步服务，将过期数据同步至历史数据。
1. 实时订单数据（例如：近3个月的订单）：将实时订单存入MySql数据库。实时订单的总量膨胀的速度得到了限制，同时保证了实时数据的多维查询、分析能力；
2. 历史订单数据（例如：3个月以前的订单）：将历史订单数据存入HBase，借助于HBase这一分布式NoSql数据库，有效应对了订单数据膨胀困扰。也保证了历史订单数据的持久化；
但是，该方案牺牲了历史订单数据对用户、商家、平台的使用价值，假设了历史数据的需求频率极低。但是一旦有需求，便需要全表扫描，查询速度慢、IO成本很高。而维护数据同步又带来了数据一致性、同步运维成本飙升等难题；

## 3、MySql+Elasticsearch方案
组合方案还有MySql+Elasticsearch，该方案同样是将数据分两部分存储，可以一定程度解决订单索引维度增长问题。用户自己维护数据同步服务，保证两部分数据的一致性；
1. 全量数据：将全量的订单数据存入MySql数据库，订单ID之外的数据整体存为一个字段。该全量数据作为持久化存储，也用于非索引字段的反查；
2. 查询数据：仅将需要检索的字段存入Elasticsearch（基于Lucene分布式索引数据库），借助于>Elasticsearch的索引能力，提供可以应付维度膨胀的订单数据，然后必要时反查MySql获取订单完整信息；
该方案应付了数据维度膨胀带来的困扰，但是随着订单量的不断膨胀，MySql扩展性差的问题再次暴露出来。同时数据同步至Elasticsearch的方案，开发、运维成本很高，方案选择也存在弊端。



# 方案示例参考
[新美大外卖订单系统架构实践](https://myslide.cn/slides/3486)
[有赞订单管理的三生三世与“十面埋伏”](https://tech.youzan.com/trade_manage/)
[TableStore实战：亿量级订单管理解决方案](https://cnodejs.org/topic/5c35fcdd3898674067a7d53d)
[订单中心基于elasticsearch 的解决方案](https://elasticsearch.cn/article/6197)
