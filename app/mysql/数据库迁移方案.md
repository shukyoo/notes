# 业务连续性 方案

描述：通过底层数据库复制冲突检测跳过的方式，保证迁移前后服务可持续正常写入，但存在一些数据写入丢失。   

**风险点和服务影响：**
* 需要重启服务或者重载配置，才能使域名生效
* 在切换期间会出现一段时间的双写，双写期间数据会有潜在冲突丢失。且由于异步复制的架构，可能会读到陈旧的数据
* 所有服务生效的间隔时长越长，数据潜在丢失可能越多

**迁移过程：**
1. 准备阶段    
    a. 准备实例（schema导入，创建复制，创建应用账号）—DBA   
    b. 配置为双向复制拓扑，以便回滚 ---DBA   
    c. 准备服务的数据库连接配置 ---应用运维   

2. 执行阶段   
    a. 重启服务/重载配置，使新的配置生效 ---应用运维   
    b. 确认源实例相关表是否还有访问 ---DBA   

3. 收尾阶段 ---DBA   
    a. 停止并清空数据库复制，实例拆分独立   
    b. 源实例的schema删除   


# 数据一致性 方案

描述：通过对实例添加短暂的写锁，实现迁移前后主备的一致性的状态。

**风险点：**
* 在切换过程中，需要保证切换时间点主备数据一致，会短暂的拒绝原主上的写入操作
* 在切换时，如果有较长的写入操作，所在连接可能因主程序等待超时被杀掉

**迁移过程：**
1. 准备阶段   
    a. 准备实例（schema导入，创建复制，创建应用账号），并提供新域名，CNAME指向原实例上  —DBA   
    b. 配置为双向复制拓扑，以便回滚 ---DBA   
    c. 准备服务的数据库连接配置(新域名) ---应用运维   
    d. 重启服务/重载配置，使新的配置生效 ---应用运维   
    
2. 执行阶段  —DBA   
    a. 对原实例中迁移的schema下所有表进行写锁   
    b. 变更新域名指向目标实例   
    c. kill掉所有原实例该schema下的所有连接，直到连接都重连到目标实例（短连接不需要这一步）   
    
3. 收尾阶段   —DBA   
    a. 停止并清空数据库复制，实例拆分独立   
    b. 源实例的schema删除   


备注：若目标实例已存在或者同时跨实例的schema迁移时，则新域名为临时域名，最后收尾阶段需要额外完成
* 将CNAME临时域名改为目标实例正式记录--DBA
* 修改服务的数据库连接配置（正式记录） --应用运维
* 重启服务/重载配置，使新的配置生效  --应用运维
* 删除CNAME临时域名 --DBA
