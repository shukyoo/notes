# 故障预防/控制的手段：
| 参数 | 类型 | 说明 | 全局默认值 | 风险点 | 备注 |
| --- | --- | --- | --- | --- | --- |
| long_query_time | session/global | 慢查记录时间 | 2秒 | 设置过长的慢查时间，会增加潜在的并发风险 | 在MySQL内执行时间超过该参数时会被记录在慢日志中，如果是新产生的慢查，DBA每日巡检会发现并给出优化方案 |
| max_execute_time | session/global | 查询超时时间 | 0（永远不超时） | 全局设置会增加被误杀概率；以及超时后业务服务的响应并不明确 | 单位：毫秒，若超时直接抛错：ERROR 1317 (70100): Query execution was interrupted，请求被杀，但连接仍存活 |
* session变量的使用方法，在执行语句前执行：如，set session long_query_time = xxx;
* 如果不设置session，则默认使用global值。
* 除特殊情况外，global值不建议进行调整。
 
 

# 常用处置手段清单：
| 处置手段 | 说明 | 使用场景 | 风险点 | 默认阈值 | 处置成本 |
| --- | --- | --- | --- | --- | --- |
| SQL Rewrite | SQL改写，直接返回一个固定值 | 处理异常SQL使用，而避免查询数据库产生性能开销 | 业务侧的风险，返回值需要谨慎设置 | 高 |
| kill慢查连接 | 直接kill执行时间超过阈值的连接 | 大量执行过慢的查询占用了过多的数据库资源 | 业务侧的风险，被杀掉连接的服务的处理逻辑影响不明 | 2s | 低 |
| kill空闲连接 | 直接kill空闲时间超过阈值的连接 | 大量空闲连接占用了过多连接数 | 业务侧的风险，被杀掉连接的服务的处理逻辑影响不明 | 5s | 低 |
| 临时增加最大连接数 | 设置更大的max_connection | 连接数不足 | 数据库侧的风险，每增加一个连接会显式/隐式的增加内存的开销(警告)，可能会导致数据库OOM | 翻倍 | 低 |
| 手动主备切换 | 手动完成数据库主备切换 | 怀疑现有主库有异常，希望通过主备切换解决故障 | 业务侧的风险，详见 基于MHA的MySQL主备切换 |   | 高 |
| 重启（非failover） | 非failover的方式重启数据库 | 遇到数据库Bug，导致现有处置方案都不适用 | 业务侧的风险，重启期间数据库不可访问，重启时间可能较长，重启内存数据需要重新加载 |   | 中 |
| 重启（failover） | failover的方式重启数据库 | 适用于配置了多可用区的AWS RDS | 业务侧的风险，failover期间数据库不可访问，failover时间因实例规模/当时负载有所不同，重启内存数据需要重新加载 |   | 低 |
| 添加索引 | 添加索引，使得执行更快 | 个别查询因没有走索引，执行较慢，占用过多数据库资源 | 业务侧的风险，不确定添加索引后是否会触发服务的处理逻辑异常 |   | 中 |
| 使用blackhole引擎 | 使用blackhole存储引擎，更快响应请求 | 数据可以丢弃，但必须要很快返回写入成功的业务场景 | 业务侧的风险，数据是否可以丢弃需要谨慎考虑 |   | 低 |
| 新建表/再重命名 | 新建表，使得业务先写入新表，待旧表可用，再重命名回来，然后将新增数据再回写到旧表中 | 旧表有异常，新增数据不可丢弃，且必须要返回写入成功的业务场景 | 业务侧的风险，写新表期间，基于旧表数据的更新/删除会丢失，查询只能查询到新表数据 |   | 高 |
| 实例设置为只读 | set global read_only = on，所有写操作直接抛错 | 需要将写降级，优先服务读操作的场景 | 业务侧的风险，写操作直接抛错，不确定服务是否有抛错处理 |   | 低 |
| 主库写缓 | set binlog_group_commit_sync_delay=N，使得写入延迟返回0-N微秒区间，增加复制的并发度 | 并行复制仍旧出现延迟的场景 | 业务侧的风险，不确定写入变缓对服务的可用性影响1000 | 低 |

mysql每个连接内存开销公式：
* 最大情况：select @@read_buffer_size +@@read_rnd_buffer_size+@@sort_buffer_size+@@join_buffer_size+@@binlog_cache_size+@@thread_stack = 79.1875 MB
* 最小情况：select @@thread_stack = 192 KB

 

# 常见故障场景及默认处置方式：
| 故障类型 | 故障场景 | 默认处置方式（优先1，不佳，则2） |
| --- | --- | --- |
| 复制延迟 | 触发复制延迟报警 | 主库写缓 |
| 连接数 | 触发数据库连接数报警 | 1.临时增加最大连接数，2.kill空闲连接 |
| 慢查 | 因慢查堆积触发数据库资源的报警，如cpu、thread_running等 | kill慢查连接 |
| bug | 发现mysql存在较难处置的bug | 1.重启（非failover），2.手动主备切换 |
